<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Публикация в ВКонтакте</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="second.css">
</head>
<body>
  <div class="particles" id="particles"></div>

  <header>
    <div class="header-content">
      <a href="index.html" class="logo">
        <img src="img/logo%20%D0%B1%D0%B5%D0%BB%D1%8B%D0%B9.png" alt="Витрина моды">
      </a>
      <div class="header-text">
        <i class="fas fa-share-alt"></i> Публикация в ВКонтакте
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="panel">
      <h2>Создание поста</h2>
      <form class="post-form" id="postForm">
        <div class="form-group">
          <div class="platform-info">
            <i class="fab fa-vk platform-icon"></i>
            <div class="platform-details">
              <div class="platform-name">ВКонтакте</div>
              <div class="platform-status">✓ Подключено к группе ID: 233256913</div>
              <div id="apiStatus" class="api-status">
                <i class="fas fa-sync fa-spin"></i> Проверка подключения...
              </div>
              <div class="test-buttons">
                <button type="button" class="test-btn" onclick="testConnection()">Тест подключения</button>
                <button type="button" class="test-btn" onclick="testPostPublishing()">Тест публикации</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="postText"><i class="fas fa-edit"></i> Текст поста</label>
          <textarea id="postText" placeholder="Введите текст для публикации в ВКонтакте..." maxlength="4000"></textarea>
          <div class="char-counter">
            <span id="charCount">0</span>/4000 символов
          </div>
        </div>

        <div class="form-group">
          <label><i class="fas fa-image"></i> Прикрепление фото из ВКонтакте</label>
          <div class="photo-attachment">
            <p><strong>Вставьте ссылку на фото из ВКонтакте:</strong></p>
            <div class="photo-inputs">
              <input type="url" id="photoUrl" placeholder="https://vk.com/photo123456789_456239021" class="form-control">
              <button type="button" class="btn-secondary" id="parseUrlBtn">
                <i class="fas fa-link"></i> Извлечь ID
              </button>
            </div>
            <div id="extractedInfo" class="extracted-info" style="display: none;">
              <i class="fas fa-check-circle"></i> ID извлечены: <span id="photoIds"></span>
            </div>
            <div class="photo-preview">
              <img id="previewImage" class="preview-image" src="" alt="Предпросмотр изображения">
            </div>
            <small style="color: var(--text-secondary); margin-top: 8px; display: block;">
              Поддерживаются ссылки на фото из ВКонтакте
            </small>
          </div>
        </div>

        <div class="form-group">
          <label><i class="fas fa-clock"></i> Настройки публикации</label>
          <div class="schedule-options">
            <div class="schedule-toggle">
              <label class="toggle-switch">
                <input type="checkbox" id="scheduleToggle">
                <span class="toggle-slider"></span>
              </label>
              <span>Отложенная публикация</span>
            </div>
            
            <div class="datetime-input" id="datetimeInput">
              <input type="datetime-local" id="scheduleDateTime">
            </div>
          </div>
        </div>

        <div class="form-group">
          <div class="schedule-toggle">
            <label class="toggle-switch">
              <input type="checkbox" id="fromGroup" checked>
              <span class="toggle-slider"></span>
            </label>
            <span>Опубликовать от имени сообщества</span>
          </div>
          <div class="schedule-toggle">
            <label class="toggle-switch">
              <input type="checkbox" id="signed" checked>
              <span class="toggle-slider"></span>
            </label>
            <span>Подписать автора (администратора)</span>
          </div>
        </div>
        
        <div class="button-group">
          <button type="button" class="btn-primary" id="publishBtn">
            <i class="fas fa-paper-plane"></i> Опубликовать в ВК
          </button>
          <button type="button" class="btn-secondary" id="previewBtn">
            <i class="fas fa-eye"></i> Предпросмотр
          </button>
        </div>
        
        <div class="status-message success" id="successMessage">
          <i class="fas fa-check-circle"></i> Пост успешно опубликован в ВКонтакте!
        </div>
        
        <div class="status-message error" id="errorMessage">
          <i class="fas fa-exclamation-triangle"></i> Произошла ошибка при публикации
        </div>

        <div class="debug-info" id="debugInfo">
          Режим отладки: информация о запросах будет отображаться здесь
        </div>
      </form>
    </div>
    
    <div class="panel">
      <h2>История публикаций</h2>
      <div class="form-group">
        <input type="text" id="searchHistory" placeholder="Поиск по истории..." class="form-control">
      </div>
      <div class="local-history">
        <div id="historyList">
          <div class="history-item">
            <div class="history-text">Здесь будет отображаться история ваших постов</div>
            <div class="history-meta">
              <span>--.--.---- --:--</span>
              <span class="history-status">Готов</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Функция для создания частиц
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 25;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // Случайные начальные позиции
        const left = Math.random() * 100;
        const size = Math.random() * 3 + 1;
        const opacity = Math.random() * 0.5 + 0.2;
        const animationDuration = Math.random() * 20 + 10;
        const animationDelay = Math.random() * 5;
        
        particle.style.left = `${left}%`;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.opacity = opacity;
        particle.style.animationDuration = `${animationDuration}s`;
        particle.style.animationDelay = `${animationDelay}s`;
        
        particlesContainer.appendChild(particle);
      }
    }

    const VK_TOKEN = 'vk1.a.7uJ7G6fmHIYr8WGbLxDwJihIVjf1cF6HAIJ0WiCB9BpphP57D09rQhsu2lpOWT8dDjOuQldkbye8UyhtBK764iHAbrMy5zipVhBmrlJW-q45e1htB4sxiAtMWa9QpssoffYG8k6YolcvLogAMIykahh5IHc7pBvf7KJSr12EO_rM1TWiHWdm9WGk7bYKK3cAQEzzIKcVY86iD2MIqKRIRQ';
    const GROUP_ID = '-233729508';
    let localHistory = JSON.parse(localStorage.getItem('vk_publish_history') || '[]');
    let extractedPhotoIds = [];

    // Инициализация
    document.addEventListener('DOMContentLoaded', function() {
      createParticles();
      initializeScheduleToggle();
      checkTokenValidity();
      loadLocalHistory();
      setupCharCounter();
      setupUrlParser();
      
      // Загружаем черновик если есть
      const savedDraft = localStorage.getItem('vk_draft');
      if (savedDraft) {
        document.getElementById('postText').value = savedDraft;
        document.getElementById('charCount').textContent = savedDraft.length;
      }
    });

    // Счетчик символов
    function setupCharCounter() {
      const postText = document.getElementById('postText');
      const charCount = document.getElementById('charCount');
      
      postText.addEventListener('input', function() {
        charCount.textContent = this.value.length;
      });
    }

    // Парсер ссылок ВК
    function setupUrlParser() {
      const parseBtn = document.getElementById('parseUrlBtn');
      const photoUrl = document.getElementById('photoUrl');
      
      parseBtn.addEventListener('click', function() {
        const url = photoUrl.value.trim();
        if (!url) {
          showMessage('Введите ссылку на фото', 'error');
          return;
        }
        
        const photoIds = extractPhotoIdsFromUrl(url);
        if (photoIds.length > 0) {
          extractedPhotoIds = photoIds;
          displayExtractedIds(photoIds);
          showMessage(`Успешно извлечено ${photoIds.length} ID фото`, 'success');
          loadPhotoPreview(photoIds[0]);
        } else {
          showMessage('Не удалось извлечь ID фото из ссылки', 'error');
        }
      });
      
      // Автоматический парсинг при вставке
      photoUrl.addEventListener('paste', function(e) {
        setTimeout(() => {
          const url = photoUrl.value.trim();
          const photoIds = extractPhotoIdsFromUrl(url);
          if (photoIds.length > 0) {
            extractedPhotoIds = photoIds;
            displayExtractedIds(photoIds);
            loadPhotoPreview(photoIds[0]);
          }
        }, 100);
      });
    }

    // Извлечение ID фото из различных форматов ссылок ВК
    function extractPhotoIdsFromUrl(url) {
      const patterns = [
        // photo123456789_456239021
        /photo(-?\d+)_(\d+)/,
        // https://vk.com/photo123456789_456239021
        /vk\.com\/photo(-?\d+)_(\d+)/,
        // https://vk.com/wall123456789?z=photo123456789_456239021
        /z=photo(-?\d+)_(\d+)/,
        // albums123456789/456239021
        /albums(-?\d+)\/(\d+)/,
        // photos123456789/456239021
        /photos(-?\d+)\/(\d+)/
      ];
      
      const photoIds = [];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          const ownerId = match[1];
          const photoId = match[2];
          photoIds.push(`${ownerId}_${photoId}`);
        }
      }
      
      return photoIds;
    }

    // Отображение извлеченных ID
    function displayExtractedIds(photoIds) {
      const extractedInfo = document.getElementById('extractedInfo');
      const photoIdsSpan = document.getElementById('photoIds');
      
      photoIdsSpan.textContent = photoIds.map(id => `photo${id}`).join(', ');
      extractedInfo.style.display = 'block';
    }

    // Загрузка превью фото
    function loadPhotoPreview(photoId) {
      const previewImage = document.getElementById('previewImage');
      
      // Пробуем разные варианты URL для превью
      const previewUrls = [
        `https://sun9-71.userapi.com/impg/${photoId.replace('_', '/')}.jpg`,
        `https://sun1-87.userapi.com/impg/${photoId.replace('_', '/')}.jpg`,
        `https://sun9-74.userapi.com/impg/${photoId.replace('_', '/')}.jpg`
      ];
      
      let currentUrlIndex = 0;
      
      function tryNextUrl() {
        if (currentUrlIndex >= previewUrls.length) {
          previewImage.style.display = 'none';
          return;
        }
        
        previewImage.src = previewUrls[currentUrlIndex];
        previewImage.style.display = 'block';
        
        previewImage.onload = function() {
          // Фото загружено успешно
        };
        
        previewImage.onerror = function() {
          currentUrlIndex++;
          tryNextUrl();
        };
      }
      
      tryNextUrl();
    }

    // Инициализация переключателя расписания
    function initializeScheduleToggle() {
      const scheduleToggle = document.getElementById('scheduleToggle');
      const datetimeInput = document.getElementById('datetimeInput');
      
      if (scheduleToggle && datetimeInput) {
        scheduleToggle.addEventListener('change', function() {
          if (this.checked) {
            datetimeInput.classList.add('active');
            const minDate = new Date(Date.now() + 5 * 60 * 1000);
            document.getElementById('scheduleDateTime').min = minDate.toISOString().slice(0, 16);
            const defaultDate = new Date(Date.now() + 60 * 60 * 1000);
            document.getElementById('scheduleDateTime').value = defaultDate.toISOString().slice(0, 16);
          } else {
            datetimeInput.classList.remove('active');
          }
        });
      }
    }

    // JSONP функция для обхода CORS
    function callVKAPI(method, params = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        const script = document.createElement('script');
        
        const baseParams = {
          access_token: VK_TOKEN,
          v: '5.199'
        };
        
        const allParams = { ...baseParams, ...params };
        allParams.callback = callbackName;
        
        const paramString = Object.keys(allParams)
          .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(allParams[key])}`)
          .join('&');
        
        const url = `https://api.vk.com/method/${method}?${paramString}`;
        
        updateDebugInfo(`Отправка запроса: ${method}`);
        
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          
          if (data.error) {
            updateDebugInfo(`Ошибка API: ${data.error.error_msg}`);
            reject(new Error(`VK API: ${data.error.error_msg} (код: ${data.error.error_code})`));
          } else {
            updateDebugInfo(`Успешный ответ: ${method}`);
            resolve(data.response);
          }
        };
        
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          updateDebugInfo('Ошибка загрузки скрипта');
          reject(new Error('Ошибка загрузки скрипта VK API'));
        };
        
        script.src = url;
        document.body.appendChild(script);
      });
    }

    // Тест подключения
    async function testConnection() {
      try {
        showMessage('Тестирование подключения...', 'success');
        const result = await callVKAPI('wall.post', {
          owner_id: GROUP_ID,
          message: 'Тестовый пост - проверка подключения',
          publish_date: Math.floor(Date.now() / 1000) + 300
        });
        showMessage('✓ Подключение успешно! Можно публиковать посты', 'success');
      } catch (error) {
        if (error.message.includes('wall.post')) {
          showMessage('✓ Подключение работает! Ошибка ожидаема для тестового поста', 'success');
        } else {
          showMessage('✗ Ошибка подключения: ' + error.message, 'error');
        }
      }
    }

    // Тест публикации
    async function testPostPublishing() {
      try {
        showMessage('Тест публикации...', 'success');
        const result = await callVKAPI('wall.post', {
          owner_id: GROUP_ID,
          message: 'Тестовый пост от ' + new Date().toLocaleString('ru-RU'),
          from_group: 1,
          signed: 1
        });
        showMessage('✓ Тест успешен! Пост опубликован с ID: ' + result.post_id, 'success');
        addToLocalHistory('Тестовый пост', result.post_id, true);
      } catch (error) {
        showMessage('✗ Ошибка теста: ' + error.message, 'error');
      }
    }

    async function checkTokenValidity() {
      try {
        await callVKAPI('wall.post', {
          owner_id: GROUP_ID,
          message: 'test',
          publish_date: Math.floor(Date.now() / 1000) + 3600
        });
        
        document.getElementById('apiStatus').className = 'api-status connected';
        document.getElementById('apiStatus').innerHTML = 
          `<i class="fas fa-check-circle"></i> Токен валиден, можно публиковать посты`;
          
      } catch (error) {
        if (error.message.includes('wall.post')) {
          document.getElementById('apiStatus').className = 'api-status connected';
          document.getElementById('apiStatus').innerHTML = 
            `<i class="fas fa-check-circle"></i> Подключение активно (ошибка в тестовом посте ожидаема)`;
        } else {
          document.getElementById('apiStatus').className = 'api-status error';
          document.getElementById('apiStatus').innerHTML = 
            `<i class="fas fa-exclamation-triangle"></i> Ошибка: ${error.message}`;
        }
      }
    }

    // Публикация поста
    document.getElementById('publishBtn').addEventListener('click', async function() {
      const postText = document.getElementById('postText').value.trim();
      const publishBtn = this;
      
      if (!postText) {
        showMessage('Введите текст поста', 'error');
        return;
      }
      
      publishBtn.classList.add('button-loading');
      publishBtn.disabled = true;
      
      try {
        // Параметры для публикации
        const params = {
          owner_id: GROUP_ID,
          message: postText,
          from_group: document.getElementById('fromGroup').checked ? 1 : 0,
          signed: document.getElementById('signed').checked ? 1 : 0
        };
        
        // Добавляем фото если есть извлеченные ID
        if (extractedPhotoIds.length > 0) {
          const attachments = extractedPhotoIds.map(id => `photo${id}`).join(',');
          params.attachments = attachments;
          updateDebugInfo(`Прикрепляемые фото: ${attachments}`);
        }
        
        // Отложенная публикация
        const scheduleToggle = document.getElementById('scheduleToggle');
        if (scheduleToggle && scheduleToggle.checked) {
          const dateTimeInput = document.getElementById('scheduleDateTime');
          if (dateTimeInput && dateTimeInput.value) {
            const dateTime = new Date(dateTimeInput.value);
            if (dateTime > new Date()) {
              params.publish_date = Math.floor(dateTime.getTime() / 1000);
              updateDebugInfo(`Отложенная публикация: ${dateTime.toLocaleString('ru-RU')}`);
            }
          }
        }
        
        updateDebugInfo(`Публикация поста: ${postText.substring(0, 50)}...`);
        
        // Публикуем пост
        const result = await callVKAPI('wall.post', params);
        
        let successMsg = '✓ Пост успешно опубликован в ВКонтакте! ID: ' + result.post_id;
        if (extractedPhotoIds.length > 0) {
          successMsg += ` с ${extractedPhotoIds.length} фото`;
        }
        showMessage(successMsg, 'success');
        updateDebugInfo(`Пост опубликован с ID: ${result.post_id}`);
        
        // Добавляем в локальную историю
        addToLocalHistory(postText, result.post_id, true);
        
        // Очищаем форму
        resetForm();
        
      } catch (error) {
        const errorMsg = '✗ Ошибка публикации: ' + error.message;
        showMessage(errorMsg, 'error');
        updateDebugInfo(errorMsg);
        
        addToLocalHistory(postText, 'error', false);
        
        console.error('Publish error:', error);
      } finally {
        publishBtn.classList.remove('button-loading');
        publishBtn.disabled = false;
      }
    });

    // Предпросмотр
    document.getElementById('previewBtn').addEventListener('click', function() {
      const postText = document.getElementById('postText').value.trim();
      if (!postText) {
        showMessage('Введите текст поста для предпросмотра', 'error');
        return;
      }
      
      localStorage.setItem('vk_draft', postText);
      
      let previewInfo = 'Текст поста готов к публикации. ';
      if (extractedPhotoIds.length > 0) {
        previewInfo += `Будет прикреплено ${extractedPhotoIds.length} фото`;
      } else {
        previewInfo += 'Фото не прикреплены.';
      }
      
      showMessage(previewInfo, 'success');
    });

    // Локальная история в браузере
    function addToLocalHistory(text, postId, success) {
      const historyItem = {
        id: Date.now(),
        text: text,
        postId: postId,
        success: success,
        timestamp: new Date().toISOString(),
        date: new Date().toLocaleString('ru-RU')
      };
      
      localHistory.unshift(historyItem);
      localHistory = localHistory.slice(0, 50);
      localStorage.setItem('vk_publish_history', JSON.stringify(localHistory));
      
      loadLocalHistory();
    }

    function loadLocalHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      
      if (localHistory.length === 0) {
        historyList.innerHTML = `
          <div class="history-item">
            <div class="history-text">История публикаций пуста</div>
            <div class="history-meta">
              <span>--.--.---- --:--</span>
              <span class="history-status">Нет данных</span>
            </div>
          </div>
        `;
        return;
      }
      
      localHistory.forEach(item => {
        const shortText = item.text.length > 100 ? item.text.substring(0, 100) + '...' : item.text;
        const status = item.success ? '✅ Успешно' : '❌ Ошибка';
        const statusColor = item.success ? '#4caf50' : '#f44336';
        
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div class="history-text">${shortText}</div>
          <div class="history-meta">
            <span>${item.date}</span>
            <span class="history-status" style="color: ${statusColor};">${status}</span>
          </div>
          ${item.postId && item.postId !== 'error' ? 
            `<div style="font-size: 0.7rem; color: var(--text-secondary);">ID поста: ${item.postId}</div>` : ''}
        `;
        historyList.appendChild(historyItem);
      });
    }

    // Сброс формы
    function resetForm() {
      document.getElementById('postText').value = '';
      document.getElementById('photoUrl').value = '';
      document.getElementById('charCount').textContent = '0';
      document.getElementById('scheduleToggle').checked = false;
      document.getElementById('datetimeInput').classList.remove('active');
      document.getElementById('extractedInfo').style.display = 'none';
      document.getElementById('previewImage').style.display = 'none';
      extractedPhotoIds = [];
      localStorage.removeItem('vk_draft');
    }

    // Показать сообщение
    function showMessage(text, type) {
      const messageEl = type === 'success' ? 
        document.getElementById('successMessage') : 
        document.getElementById('errorMessage');
      
      messageEl.innerHTML = type === 'success' ? 
        `<i class="fas fa-check-circle"></i> ${text}` :
        `<i class="fas fa-exclamation-triangle"></i> ${text}`;
      
      messageEl.style.display = 'block';
      
      const otherMessageEl = type === 'success' ? 
        document.getElementById('errorMessage') : 
        document.getElementById('successMessage');
      otherMessageEl.style.display = 'none';
      
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 5000);
    }

    // Обновление отладочной информации
    function updateDebugInfo(message) {
      const debugEl = document.getElementById('debugInfo');
      const timestamp = new Date().toLocaleTimeString();
      debugEl.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
    }

    // Поиск по истории
    document.getElementById('searchHistory').addEventListener('input', function(e) {
      const searchTerm = e.target.value.toLowerCase();
      const historyItems = document.querySelectorAll('.history-item');
      
      historyItems.forEach(item => {
        const text = item.querySelector('.history-text').textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>